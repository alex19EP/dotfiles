{{ if eq .osid "linux-debian" "linux-arch" -}}

{{ $packages := list
     "curl"
     "direnv"
     "fzf"
     "git-lfs"
     "gnupg"
     "git"
     "jq"
     "nnn"
     "tmux"
     "ripgrep"
     "rustup"
     "nano"
     "pcsclite"
     "tealdeer"
     "shellcheck"
     "urlscan"
     "zoxide"
     "zsh"
-}}
{{ if not .sberos -}}
{{   $packages = mustAppend $packages "atuin" -}}
{{ end -}}

{{/* Wayland detection */ -}}
{{ $wayland := or (eq (env "XDG_SESSION_TYPE") "wayland") (env "WAYLAND_DISPLAY" | not | not) -}}

{{ if not .headless -}}
{{   if $wayland -}}
{{     $packages = mustAppend $packages "wl-clipboard" -}}
{{   else -}}
{{     $packages = mustAppend $packages "xclip" -}}
{{   end -}}
{{ end -}}

{{/* Map canonical names -> per-distro package names (only specify differences). */ -}}
{{ $pkgOverrides := dict
  "linux-debian" (dict
    "pcsclite" "libpcsclite1"
  )
-}}

{{/* Resolve per-distro package names. Unspecified packages keep their canonical names. */ -}}
{{ $resolved := list -}}
{{ $over := dict -}}
{{ if hasKey $pkgOverrides .osid -}}
{{   $over = index $pkgOverrides .osid -}}
{{ end -}}
{{ range $packages -}}
{{   $name := . -}}
{{   if and $over (hasKey $over .) -}}
{{     $name = index $over . -}}
{{   end -}}
{{   $resolved = mustAppend $resolved $name -}}
{{ end -}}

{{ $sudo := "sudo " -}}
{{ if eq .chezmoi.username "root" -}}
{{   $sudo = "" -}}
{{ end -}}

#!/bin/bash

set -eufo pipefail

{{ $sudo }}{{ template "pmInstall" . }} {{ $resolved | join " " }}

{{ end -}}
